<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of write_to_afni</title>
  <meta name="keywords" content="write_to_afni">
  <meta name="description" content="Writes an object to a file, using the header info from a specified file.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<!-- menu.html . -->
<h1>write_to_afni
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Writes an object to a file, using the header info from a specified file.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [err] = write_to_afni(subj, objtype, objname, sample_filename, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Writes an object to a file, using the header info from a specified file.

 [ERR] = WRITE_TO_AFNI(SUBJ, OBJTYPE, OBJNAME, SAMPLE_FILENAME, [ARGS])

 Writes an object in subject structure SUBJ, of type OBJTYPE to a
 file. OBJNAME specifies the object, and must be an object name, a
 group name, or a cell array of object names. SAMPLE_FILENAME must
 currently be included to steal HEAD info from. This should
 ideally correspond to the data. If you can choose a SAMPLE_FILENAME that
 took part in the creation of the object, do so. If a pattern was
 created by concatenating multiple files, it makes no difference
 which is specified by SAMPLE_FILENAME. Currently, the difficulties in
 specifying a mask BRIK when writing a pattern OBJNAME are
 minimal (ie., mislabeling the type of the object as FIM, not ORIG).

 Optionally, the ARGS structure can contain the following info:
 - output_filename : the prefix of the BRIK to be saved.  This can
   be a filename, a group prefix, or a cell array of object names,
   and must correspond to the form of OBJNAME. If this is left
   out, the prefix of the BRIK will be OBJNAME.
 - runs : a selector name that specifies run info. If this is
   included, a different BRIK will be written for each run of
   data. OBJNAME must, in this case, be a single object. If runs
   is not included, a single file will be created for each object.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="find_group.html" class="code" title="function [matches] = find_group(subj,objtype,groupname)">find_group</a>	Returns a list of names of objects from this group</li><li><a href="get_mat.html" class="code" title="function [mat] = get_mat(subj,objtype,objname)">get_mat</a>	Returns the MAT field of the object</li><li><a href="get_objfield.html" class="code" title="function [val] = get_objfield(subj,objtype,objname,fieldname)">get_objfield</a>	Retrieves a field from an object</li><li><a href="propval.html" class="code" title="function [combined_struct user_struct undefaulted_struct] = propval(user_propvals,defaults_struct)">propval</a>	This deals with property/value pairs of optional arguments.</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [err] = write_to_afni(subj, objtype, objname, sample_filename, varargin)</a>
0002 
0003 <span class="comment">% Writes an object to a file, using the header info from a specified file.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% [ERR] = WRITE_TO_AFNI(SUBJ, OBJTYPE, OBJNAME, SAMPLE_FILENAME, [ARGS])</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Writes an object in subject structure SUBJ, of type OBJTYPE to a</span>
0008 <span class="comment">% file. OBJNAME specifies the object, and must be an object name, a</span>
0009 <span class="comment">% group name, or a cell array of object names. SAMPLE_FILENAME must</span>
0010 <span class="comment">% currently be included to steal HEAD info from. This should</span>
0011 <span class="comment">% ideally correspond to the data. If you can choose a SAMPLE_FILENAME that</span>
0012 <span class="comment">% took part in the creation of the object, do so. If a pattern was</span>
0013 <span class="comment">% created by concatenating multiple files, it makes no difference</span>
0014 <span class="comment">% which is specified by SAMPLE_FILENAME. Currently, the difficulties in</span>
0015 <span class="comment">% specifying a mask BRIK when writing a pattern OBJNAME are</span>
0016 <span class="comment">% minimal (ie., mislabeling the type of the object as FIM, not ORIG).</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% Optionally, the ARGS structure can contain the following info:</span>
0019 <span class="comment">% - output_filename : the prefix of the BRIK to be saved.  This can</span>
0020 <span class="comment">%   be a filename, a group prefix, or a cell array of object names,</span>
0021 <span class="comment">%   and must correspond to the form of OBJNAME. If this is left</span>
0022 <span class="comment">%   out, the prefix of the BRIK will be OBJNAME.</span>
0023 <span class="comment">% - runs : a selector name that specifies run info. If this is</span>
0024 <span class="comment">%   included, a different BRIK will be written for each run of</span>
0025 <span class="comment">%   data. OBJNAME must, in this case, be a single object. If runs</span>
0026 <span class="comment">%   is not included, a single file will be created for each object.</span>
0027 
0028 <span class="comment">% Interpret OBJNAME</span>
0029 <span class="keyword">if</span> ~iscell(objname)
0030   grpmem = <a href="find_group.html" class="code" title="function [matches] = find_group(subj,objtype,groupname)">find_group</a>(subj,objtype,objname);
0031   <span class="keyword">if</span> ~isempty(grpmem)
0032     <span class="comment">% Its a group of patterns</span>
0033     objname = grpmem;
0034     
0035     default.output_filename = grpmem;
0036   <span class="keyword">else</span>
0037     <span class="comment">% It's a single pattern</span>
0038     objname = {objname};
0039     default.output_filename = objname;
0040   <span class="keyword">end</span>
0041   <span class="comment">% Otherwise, its a cell array of patterns</span>
0042 <span class="keyword">else</span>
0043   default.output_filename = objname;
0044 <span class="keyword">end</span>
0045 
0046 <span class="comment">% Process optional arguments</span>
0047 default.runs = [];
0048 args = <a href="propval.html" class="code" title="function [combined_struct user_struct undefaulted_struct] = propval(user_propvals,defaults_struct)">propval</a>(varargin,default);
0049 
0050 <span class="comment">% Error Checking: Cannot output multiple files w/ run info</span>
0051 <span class="keyword">if</span> length(unique(args.runs)) &gt; 1 &amp; length(objname) &gt; 1
0052   error(<span class="string">'Cannot pass ARGS.RUNS w/ multiple object names'</span>);
0053 <span class="keyword">end</span>
0054   
0055 <span class="comment">% Load the Brik Info</span>
0056 [err, Info] = BrikInfo(sample_filename);
0057 OrigInfo = Info;
0058 <span class="keyword">if</span> err
0059   ErrMessage = <span class="string">'Could not load BRIK info'</span>;
0060   <span class="keyword">return</span>
0061 <span class="keyword">end</span>
0062 
0063 <span class="comment">% Set the output format</span>
0064 <span class="keyword">switch</span> objtype
0065 <span class="keyword">case</span> <span class="string">'pattern'</span>
0066     Info.TypeName    = <span class="string">'float'</span>;
0067     Info.TypeBytes   = 3;
0068     Info.BRICK_TYPES = 3;
0069     ispattern = 1;
0070     ismask    = 0;
0071     Info.TYPESTRING = <span class="string">'3DIM_HEAD_FUNC'</span>;
0072 <span class="keyword">case</span> <span class="string">'mask'</span>
0073     Info.TypeName    = <span class="string">'short'</span>;
0074     Info.TypeBytes   = 1;
0075     Info.BRICK_TYPES = 0;
0076     ispattern = 0;
0077     ismask    = 1;
0078 <span class="keyword">end</span>
0079 
0080 
0081 <span class="keyword">for</span> i=1:length(objname)
0082   
0083   cur_objname = objname{i};
0084 
0085   <span class="comment">% Load the data</span>
0086   d = <a href="get_mat.html" class="code" title="function [mat] = get_mat(subj,objtype,objname)">get_mat</a>(subj,objtype,cur_objname);
0087   dDim = size(d);
0088   
0089   <span class="comment">% Determine the runs to be outputed</span>
0090   <span class="keyword">if</span> ispattern
0091     <span class="keyword">if</span> isempty(args.runs)
0092       runs = ones(1,dDim(2));
0093       <span class="keyword">if</span> prod(dDim) &gt; 1000000
0094    warning([<span class="string">'Your trying to save a mighty large file... There'</span> <span class="keyword">...</span>
0095        <span class="string">' may be a memory contraint'</span>]);
0096       <span class="keyword">end</span>
0097       
0098     <span class="keyword">else</span>
0099       runs = args.runs;
0100       <span class="keyword">if</span> length(runs) ~= dDim(2);
0101    error(<span class="string">'RUNS selector does not match dataset length'</span>);
0102       <span class="keyword">end</span>
0103     <span class="keyword">end</span>
0104   <span class="keyword">end</span>
0105   
0106   <span class="keyword">for</span> j=unique(runs(find(runs)))
0107   
0108     <span class="keyword">if</span> ispattern
0109       <span class="comment">% Load masked_by mask in order to populate a 3D matrix</span>
0110       m = <a href="get_mat.html" class="code" title="function [mat] = get_mat(subj,objtype,objname)">get_mat</a>(subj,<span class="string">'mask'</span>,<a href="get_objfield.html" class="code" title="function [val] = get_objfield(subj,objtype,objname,fieldname)">get_objfield</a>(subj,<span class="string">'pattern'</span>, cur_objname,<span class="string">'masked_by'</span>));
0111       mDim = size(m);
0112         
0113       cur_TRs = find(runs == j);    
0114 
0115       M = zeros([mDim,length(cur_TRs)]);
0116       
0117       <span class="keyword">for</span> k=1:length(cur_TRs);
0118    tmp = zeros(mDim);
0119    tmp(find(m)) = d(:,k);
0120    M(:,:,:,k)   = tmp;
0121       <span class="keyword">end</span>
0122       
0123       Opt.Frames = length(cur_TRs);
0124     <span class="keyword">else</span>
0125       M = d;
0126       Opt.Frames = 1;
0127     <span class="keyword">end</span>
0128     
0129     <span class="comment">% Determine output name</span>
0130     <span class="keyword">if</span> length(unique(runs(find(runs)))) &gt; 1
0131       <span class="comment">% Pattern w/ Runs</span>
0132       Opt.Prefix = [args.output_filename{i} <span class="string">'_run'</span> num2str(j)];
0133     <span class="keyword">else</span>
0134       Opt.Prefix = args.output_filename{i};
0135     <span class="keyword">end</span>    
0136     
0137      
0138     <span class="comment">% Modify the INFO header to reflect the changes</span>
0139     Info.DATASET_RANK = [3 size(M,4) 0 0 0 0 0 0];
0140     Info.BRICK_STATS = [min(reshape(M,prod(mDim),size(M,4))) max(reshape(M,prod(mDim),size(M,4)))];
0141     Info.BRICK_TYPES      = OrigInfo.BRICK_TYPES      * ones(1,size(M,4));
0142     Info.BRICK_FLOAT_FACS = OrigInfo.BRICK_FLOAT_FACS * ones(1,size(M, 4));
0143         
0144     <span class="comment">% Write the BRIK</span>
0145     Opt.Slices = [1:size(m,3)];
0146     Opt.Frames = [1:size(M,4)];
0147     [err, ErrMessage, Info] = WriteBrik (M, Info, Opt);
0148   <span class="keyword">end</span>
0149 <span class="keyword">end</span>
0150</pre></div>
<hr><address>Generated on Wed 31-Aug-2005 15:27:57 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2003</address>
</body>
</html>